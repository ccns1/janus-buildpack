#!/bin/bash

indent() {
  sed -u 's/^/       /'
}

echo "-----> Starting Janus install.."
# Create a log file of the build as well as displaying the build on the tty as it runs
exec > >(tee aws_janus_build.log)
exec 2>&1
set -e
#ln -s /usr/include/libv4l1-videodev.h /usr/include/linux/videodev.h

cd $1

#find / -name libv4l1-videodev.h
mkdir $1/.apt/usr/include/linux
ln -s $1/.apt/usr/include/libv4l1-videodev.h $1/.apt/usr/include/linux/videodev.h

export PATH="/app/bin:$PATH"
export INCLUDE_PATH="/app/include:$INCLUDE_PATH"
export LD_LIBRARY_PATH="/app/lib:$LD_LIBRARY_PATH"
export PKG_CONFIG_PATH="/app/lib/pkgconfig:$PKG_CONFIG_PATH"

while read url; do
  cd $1
  echo "-----> Fetching $url..."
  if [ ! -d $(grep -oP "[^/]*(?=\.tar)" <<< $url) ]
  	echo "-----> Fetching $url..."
  	then
  	wget $url 
  	tar -xvf $(grep -oP "[^/]*.tar[^/]*" <<< $url)
  fi
  cd $(grep -oP "[^/]*(?=\.tar)" <<< $url)
  echo "-----> Configure $(grep -oP "[^/]*(?=\.tar)" <<< $url)..."
  CFLAGS='-w' ./configure --prefix=/app --disable-fatal-warnings
  echo "-----> Make $(grep -oP "[^/]*(?=\.tar)" <<< $url)..."
  make && make install
  echo "-----> Make $(grep -oP "[^/]*(?=\.tar)" <<< $url) Complete."
done < .janustars

wget http://gstreamer.freedesktop.org/src/gst-omx/gst-omx-1.2.0.tar.xz
tar -xvf $1/gst-omx-1.2.0.tar.xz
cd $1/gst-omx-1.2.0
CFLAGS='-w' ./configure --prefix=/app --disable-fatal-warnings --with-omx-target=generic
make && make install
cd $1
git clone https://github.com/alanxz/rabbitmq-c
cd $1/rabbitmq-c
git submodule init
git submodule update
autoreconf -i
./configure --prefix=/app && make && make install
cd $1
svn co http://sctp-refimpl.googlecode.com/svn/trunk/KERN/usrsctp usrsctp
cd $1/usrsctp
./bootstrap
./configure --prefix=/app && make && make install
cd $1
git clone git://git.libwebsockets.org/libwebsockets
mkdir $1/libwebsockets/build && cd $1/libwebsockets/build
cmake -DCMAKE_INSTALL_PREFIX:PATH=/app ..
make && make install
cd $1
git clone https://github.com/meetecho/janus-gateway.git
cd janus-gateway
sh autogen.sh
./configure --prefix=/opt/janus --enable-docs
make install
#make configs

cd $1/janus-gateway
janus --version

echo "-----> Janus install complete"