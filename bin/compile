#!/bin/bash

indent() {
  sed -u 's/^/       /'
}

echo "-----> Starting Janus install.."
# Create a log file of the build as well as displaying the build on the tty as it runs
exec > >(tee aws_janus_build.log)
exec 2>&1
set -e

cd $1

USR="$1/.apt/usr"

mkdir $USR/include/linux
ln -s $USR/include/libv4l1-videodev.h $USR/include/linux/videodev.h

export PATH="$USR/bin:$PATH"
export INCLUDE_PATH="$USR/include:$INCLUDE_PATH"
export LD_LIBRARY_PATH="$USR/lib:$LD_LIBRARY_PATH"
export PKG_CONFIG_PATH="$USR/lib/pkgconfig:$PKG_CONFIG_PATH"

while read url; do
  echo "-----> Fetching $url..."
  if [ ! -d $(grep -oP "[^/]*(?=\.tar)" <<< $url) ]
  	echo "-----> Fetching $url..."
  	then
  	wget $url 
  	tar -xvf $(grep -oP "[^/]*.tar[^/]*" <<< $url)
  fi
  cd $(grep -oP "[^/]*(?=\.tar)" <<< $url)
  echo "-----> Configure $(grep -oP "[^/]*(?=\.tar)" <<< $url)..."
  CFLAGS='-w' ./configure --prefix=$USR --enable-shared --disable-fatal-warnings
  echo "-----> Make $(grep -oP "[^/]*(?=\.tar)" <<< $url)..."
  make && make install
  echo "-----> Make $(grep -oP "[^/]*(?=\.tar)" <<< $url) Complete."
  cd ..
done < .janustars

find / -name gstreamer-plugins-base-1.0.pc
echo PKG_CONFIG_PATH

echo "-----> Janus install complete"