#!/bin/bash

indent() {
  sed -u 's/^/       /'
}

echo "-----> Starting Janus install.."
# Create a log file of the build as well as displaying the build on the tty as it runs
exec > >(tee aws_janus_build.log)
exec 2>&1
set -e
#ln -s /usr/include/libv4l1-videodev.h /usr/include/linux/videodev.h

cd $1

#ln -s $1/.apt/usr/include/libv4l1-videodev.h $1/.apt/usr/include/linux/videodev.h

while read url; do
  cd $1
  echo "-----> Fetching $url..."
  [ ! -d $(grep -oP "[^/]*(?=\.tar)" <<< $url) ] && curl -s $url | tar
  cd $(grep -oP "[^/]*(?=\.tar)" <<< $url)
  echo "-----> Configure $(grep -oP "[^/]*(?=\.tar)" <<< $url)..."
  CFLAGS='-w' ./configure --prefix=/app --disable-fatal-warnings
  echo "-----> Make $(grep -oP "[^/]*(?=\.tar)" <<< $url)..."
  make && make install
  echo "-----> Make $(grep -oP "[^/]*(?=\.tar)" <<< $url) Complete."
done < .janustars

cd $1
yasm --version
echo $LD_LIBRARY_PATH

echo "-----> Janus install complete"