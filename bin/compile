#!/bin/bash

indent() {
  sed -u 's/^/       /'
}

echo "-----> Starting Janus install.."
# Create a log file of the build as well as displaying the build on the tty as it runs
exec > >(tee aws_janus_build.log)
exec 2>&1
set -e

USR="$1/.apt/usr"

mkdir $USR/include/linux
ln -s $USR/include/libv4l1-videodev.h $USR/include/linux/videodev.h

export CFLAGS="$CFLAGS -fPIC"
export CXXFLAGS="$CXXFLAGS -fPIC"
export PATH="$PATH:$USR/bin"
export INCLUDE_PATH="$INCLUDE_PATH:$USR/include"
export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$USR/lib"
export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:$USR/lib/pkgconfig"

cd $USR/
while read url; do
  if [ ! -d $(grep -oP "[^/]*(?=\.tar)" <<< $url) ]
  	then
  	echo "-----> Fetching $url..."
  	wget $url 
  	tar -xvf $(grep -oP "[^/]*.tar[^/]*" <<< $url)
  fi
  cd $(grep -oP "[^/]*(?=\.tar)" <<< $url)
  echo "-----> Configure $(grep -oP "[^/]*(?=\.tar)" <<< $url)..."
  CFLAGS='-w -fPIC' ./configure --prefix=$USR --enable-shared --disable-fatal-warnings --with-pic --disable-asfdemux --disable-ogg --with-omx-target=generic
  echo "-----> Make $(grep -oP "[^/]*(?=\.tar)" <<< $url)..."
  make && make install
  export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:$USR/$(grep -oP "[^/]*(?=\.tar)" <<< $url)"
  if [ -d pkgconfig ]
  	then export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:$USR/$(grep -oP "[^/]*(?=\.tar)" <<< $url)/pkgconfig"
  fi
  if [ -d libs/pkgconfig ]
  	then export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:$USR/$(grep -oP "[^/]*(?=\.tar)" <<< $url)/libs/pkgconfig"
  fi
  echo "-----> Make $(grep -oP "[^/]*(?=\.tar)" <<< $url) Complete."
  cd ..
  rm $(grep -oP "[^/]*.tar[^/]*" <<< $url)
done < $1/.janustars

cd $USR/
git clone https://github.com/alanxz/rabbitmq-c
cd $USR/rabbitmq-c
git submodule init
git submodule update
autoreconf -i
./configure --prefix=$USR && make && make install
cd $USR
svn co http://sctp-refimpl.googlecode.com/svn/trunk/KERN/usrsctp usrsctp
cd $USR/usrsctp
./bootstrap
./configure --prefix=$USR && make && make install
cd $USR
git clone git://git.libwebsockets.org/libwebsockets
mkdir $USR/libwebsockets/build && cd $USR/libwebsockets/build
cmake -DCMAKE_INSTALL_PREFIX:PATH=$USR ..
make && make install
cd $USR
git clone https://github.com/meetecho/janus-gateway.git
cd janus-gateway
sh autogen.sh
./configure --prefix=/opt/janus
make install
make configs

cd $USR/janus-gateway
janus --version

echo "-----> Janus install complete"