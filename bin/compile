#!/bin/bash

indent() {
  sed -u 's/^/       /'
}

echo "-----> Starting Janus install.."
# Create a log file of the build as well as displaying the build on the tty as it runs
exec > >(tee aws_janus_build.log)
exec 2>&1
set -e

USR="$1/.apt/usr"

mkdir $USR/include/linux
ln -s $USR/include/libv4l1-videodev.h $USR/include/linux/videodev.h
ln -s $USR/include/opus/opus.h $USR/include/opus.h
ln -s $USR/include/opus/opus_multistream.h $USR/include/opus_multistream.h
ln -s $USR/include/opus/opus_types.h $USR/include/opus_types.h
ln -s $USR/include/opus/opus_defines.h $USR/include/opus_defines.h
ln -s $USR/include/sofia-sip-1.12/sofia-sip $USR/include/sofia-sip

export PATH="$PATH:$USR/bin"
export INCLUDE_PATH="$INCLUDE_PATH:$USR/include"
export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$USR/lib"
export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:$USR/lib/pkgconfig"

cd $USR/
while read url; do
  if [ ! -d $(grep -oP "[^/]*(?=\.tar)" <<< $url) ]
  	then
  	echo "-----> Fetching $url..."
  	wget $url 
  	tar -xvf $(grep -oP "[^/]*.tar[^/]*" <<< $url)
  fi
  cd $(grep -oP "[^/]*(?=\.tar)" <<< $url)
  echo "-----> Configure $(grep -oP "[^/]*(?=\.tar)" <<< $url)..."
  CPPFLAGS='-I$USR/include' CFLAGS='-w' ./configure --prefix=$USR --disable-fatal-warnings --disable-docs --disable-examples --bindir=$USR/bin --includedir=$USR/include --libdir=$USR/lib --datarootdir=$USR/share --with-omx-target=generic --disable-ogg --disable-pango --disable-goom --disable-goom2k1 --disable-opencv --disable-asfdemux --disable-dvdlpcmdec --disable-dvdsub --disable-realmedia --disable-cdio
  echo "-----> Make $(grep -oP "[^/]*(?=\.tar)" <<< $url)..."
  make && make install
  echo "-----> Make $(grep -oP "[^/]*(?=\.tar)" <<< $url) Complete."
  cd ..
  rm $(grep -oP "[^/]*.tar[^/]*" <<< $url)
done < $1/.janustars

cd $USR/
git clone https://github.com/meetecho/janus-gateway.git
cd janus-gateway
sh autogen.sh
CPPFLAGS='-I$USR/include' CFLAGS='-w' ./configure --prefix=$USR --disable-docs --bindir=$USR/bin --includedir=$USR/include --oldincludedir=$USR/include --libdir=$USR/lib --datarootdir=$USR/share --disable-plugin-audiobridge --disable-plugin-echotest --disable-plugin-recordplay --disable-plugin-sip --disable-plugin-videocall --disable-plugin-videoroom --disable-plugin-voicemail --disable-rabbitmq --disable-websockets --disable-data-channels
make
make install
make configs

cd $USR/janus-gateway
./janus --version

echo "-----> Janus install complete"